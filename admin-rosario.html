<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Panel | Rosario Garrido</title>
    
    <!-- 1. Cargar Estilos (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Cargar Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital,wght@0,400;1,400&family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 3. Cargar React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 4. Cargar Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Configuración Visual -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            base: '#FAF9F6', 
                            mocha: '#A47864', 
                            lavender: '#A78BFA', 
                            mahogany: '#7A2E2A', 
                            dark: '#1A1918'
                        }
                    },
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif'],
                        serif: ['Instrument Serif', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #FAF9F6; color: #1A1918; }
        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-pulse-ring { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #FAF9F6; }
        ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- LÓGICA DE FIREBASE (MÓDULO) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // --- PEGA AQUÍ TU CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            // apiKey: "AIzaSy...",
            // authDomain: "...",
            // ...
        };

        // Exponer funciones a la ventana global para que React las vea
        window.firebaseLib = {
            initializeApp, getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, getAuth, signInAnonymously, onAuthStateChanged, firebaseConfig
        };
    </script>

    <!-- LÓGICA DE LA APP (REACT) -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- DEFINICIÓN DE ICONOS (SVG NATIVO PARA EVITAR ERRORES) ---
        const IconBase = ({ children, size = 24, className = "", color = "currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Icons = {
            LayoutDashboard: (p) => <IconBase {...p}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconBase>,
            Users: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            Calendar: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>,
            DollarSign: (p) => <IconBase {...p}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>,
            Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></IconBase>,
            Clock: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>,
            Trash2: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            UserPlus: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></IconBase>,
            CreditCard: (p) => <IconBase {...p}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></IconBase>,
            AlertCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>,
            TrendingUp: (p) => <IconBase {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>,
            CalendarDays: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></IconBase>,
            Edit2: (p) => <IconBase {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            AlertTriangle: (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>,
            Mic: (p) => <IconBase {...p}><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/><line x1="8" x2="16" y1="22" y2="22"/></IconBase>,
            MicOff: (p) => <IconBase {...p}><line x1="2" x2="22" y1="2" y2="22"/><path d="M18.89 13.23A7.12 7.12 0 0 0 19 12v-2"/><path d="M5 10v2a7 7 0 0 0 12 5"/><path d="M15 9.34V5a3 3 0 0 0-5.68-1.33"/><path d="M9 9v3a3 3 0 0 0 5.12 2.63"/><line x1="12" x2="12" y1="19" y2="22"/><line x1="8" x2="16" y1="22" y2="22"/></IconBase>
        };

        const { Users, Calendar, DollarSign, Plus, CheckCircle, Clock, Trash2, LayoutDashboard, UserPlus, CreditCard, AlertCircle, TrendingUp, CalendarDays, Edit2, X, AlertTriangle, Mic, MicOff } = Icons;

        // --- DATOS DE EJEMPLO (MOCK) ---
        const MOCK_PATIENTS = [
            { id: 1, name: "Valentina Paz", gender: "F", system: "Isapre", packCredits: 3 },
            { id: 2, name: "Benjamín Soto", gender: "M", system: "Fonasa", packCredits: 2 },
            { id: 3, name: "Matías Araya", gender: "M", system: "Isapre", packCredits: 0 },
            { id: 4, name: "Isidora Muñoz", gender: "F", system: "Particular", packCredits: 0 },
            { id: 5, name: "Lucas Silva", gender: "M", system: "Fonasa", packCredits: 0 },
            { id: 6, name: "Emilia Rojas", gender: "F", system: "Isapre", packCredits: 0 },
            { id: 7, name: "Joaquín Pérez", gender: "M", system: "Isapre", packCredits: 0 },
            { id: 8, name: "Florencia Díaz", gender: "F", system: "Particular", packCredits: 3 },
            { id: 9, name: "Agustín Vargas", gender: "M", system: "Fonasa", packCredits: 0 },
            { id: 10, name: "Catalina Bravo", gender: "F", system: "Isapre", packCredits: 0 }
        ];

        const MOCK_APPOINTMENTS = [
            { id: 101, patientId: 1, patientName: "Valentina Paz", type: "Pack Lanzamiento (Compra)", price: 130000, paidAmount: 65000, date: "2026-02-20" },
            { id: 102, patientId: 2, patientName: "Benjamín Soto", type: "Pack Lanzamiento (Compra)", price: 130000, paidAmount: 130000, date: "2026-02-18" },
            { id: 103, patientId: 2, patientName: "Benjamín Soto", type: "Uso de Pack (Sesión)", price: 0, paidAmount: 0, date: "2026-02-25" },
            { id: 104, patientId: 3, patientName: "Matías Araya", type: "Online (Nuevo)", price: 50000, paidAmount: 50000, date: "2026-02-24" },
            { id: 105, patientId: 4, patientName: "Isidora Muñoz", type: "Presencial Santiago", price: 50000, paidAmount: 0, date: "2026-01-15" }, 
            { id: 106, patientId: 5, patientName: "Lucas Silva", type: "Online Mostazal (Antiguo)", price: 35000, paidAmount: 35000, date: "2026-02-22" },
            { id: 107, patientId: 6, patientName: "Emilia Rojas", type: "Uso de Pack (Sesión)", price: 0, paidAmount: 0, date: "2026-02-21" },
            { id: 108, patientId: 7, patientName: "Joaquín Pérez", type: "Online (Nuevo)", price: 50000, paidAmount: 25000, date: "2026-02-23" },
            { id: 109, patientId: 8, patientName: "Florencia Díaz", type: "Pack Lanzamiento (Compra)", price: 130000, paidAmount: 130000, date: "2026-02-19" },
            { id: 110, patientId: 9, patientName: "Agustín Vargas", type: "Presencial Santiago", price: 50000, paidAmount: 50000, date: "2026-02-27" }
        ];

        // --- COMPONENTES UI ---
        
        const Card = ({ title, value, subtext, icon: Icon, colorClass }) => (
            <div className="bg-white/40 backdrop-blur-md border border-white/50 rounded-3xl p-6 shadow-lg flex items-start justify-between transform transition hover:-translate-y-1">
                <div>
                    <p className="text-gray-500 text-sm font-bold uppercase tracking-wider mb-1">{title}</p>
                    <h3 className="text-3xl font-serif text-[#1A1918]">{value}</h3>
                    <p className="text-xs text-gray-400 mt-2">{subtext}</p>
                </div>
                <div className={`p-3 rounded-2xl ${colorClass} text-white shadow-md flex items-center justify-center w-12 h-12`}>
                    <Icon size={24} />
                </div>
            </div>
        );

        // --- APP PRINCIPAL ---
        function App() {
            // Inicializar estado
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [patients, setPatients] = useState(MOCK_PATIENTS);
            const [appointments, setAppointments] = useState(MOCK_APPOINTMENTS);
            
            // UI States
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalType, setModalType] = useState('');
            const [editingItem, setEditingItem] = useState(null);
            const [isListening, setIsListening] = useState(false);
            
            // Forms
            const [patientForm, setPatientForm] = useState({ name: '', gender: 'F', system: 'Isapre', packCredits: 0 });
            const [apptForm, setApptForm] = useState({ patientId: '', type: 'Online (Nuevo)', date: '', price: 50000, paidAmount: 0 });

            // Referencias a Firebase (cargadas desde window)
            const fb = window.firebaseLib || {};
            const [dbInstance, setDbInstance] = useState(null);

            // Tipos de servicio
            const SERVICE_TYPES = [
                { label: "Online (Nuevo)", price: 50000 },
                { label: "Presencial Santiago", price: 50000 },
                { label: "Online Mostazal (Antiguo)", price: 35000 },
                { label: "Pack Lanzamiento (Compra)", price: 130000, isPackSale: true },
                { label: "Uso de Pack (Sesión)", price: 0, isPackUsage: true },
            ];

            // Utils
            const formatCurrency = (amount) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(amount);
            
            const getStatus = (price, paid) => {
                if (price === 0) return { label: 'Pack Uso', color: 'bg-blue-50 text-blue-700 border-blue-100' };
                if (paid >= price) return { label: 'Pagado', color: 'bg-green-100 text-green-700 border-green-200' };
                if (paid > 0) return { label: 'Abonado', color: 'bg-yellow-100 text-yellow-700 border-yellow-200' };
                return { label: 'Pendiente', color: 'bg-red-50 text-red-600 border-red-100' };
            };

            const getPatientStatus = (patient, appointments) => {
                const patientAppts = appointments.filter(a => a.patientId === patient.id);
                if (patientAppts.length === 0) return { label: 'Nuevo / Sin Citas', color: 'text-gray-400', action: true };
                const sortedAppts = [...patientAppts].sort((a, b) => new Date(b.date) - new Date(a.date));
                const lastAppt = sortedAppts[0];
                const today = new Date().toISOString().split('T')[0];
                if (patient.packCredits > 0) return { label: `${patient.packCredits} Sesiones Pendientes`, color: 'text-brand-mocha font-bold', isPack: true };
                if (lastAppt.date >= today) return { label: `Agendado: ${lastAppt.date.slice(5)}`, color: 'text-green-600 font-medium', action: false };
                return { label: '⚠️ Agendar (Venta)', color: 'text-red-500 font-bold', action: true };
            };

            // Init Firebase
            useEffect(() => {
                if (fb.firebaseConfig && fb.firebaseConfig.apiKey) {
                    try {
                        const app = fb.initializeApp(fb.firebaseConfig);
                        const auth = fb.getAuth(app);
                        const db = fb.getFirestore(app);
                        setDbInstance(db);
                        fb.signInAnonymously(auth);
                        fb.onAuthStateChanged(auth, setUser);
                    } catch(e) { console.log("Error init firebase", e); }
                }
            }, []);

            // Listeners
            useEffect(() => {
                if (!user || !dbInstance) return;
                const appId = 'rosario-prod'; // ID único para DB
                
                const unsubP = fb.onSnapshot(fb.query(fb.collection(dbInstance, 'artifacts', appId, 'public', 'data', 'patients'), fb.orderBy('name')), 
                    (s) => { if (!s.empty) setPatients(s.docs.map(d => ({ id: d.id, ...d.data() }))); }
                );
                const unsubA = fb.onSnapshot(fb.query(fb.collection(dbInstance, 'artifacts', appId, 'public', 'data', 'appointments'), fb.orderBy('date', 'desc')), 
                    (s) => { if (!s.empty) setAppointments(s.docs.map(d => ({ id: d.id, ...d.data() }))); }
                );
                return () => { unsubP(); unsubA(); };
            }, [user, dbInstance]);

            // Cálculos
            const financials = useMemo(() => {
                const totalCollected = appointments.reduce((acc, curr) => acc + (curr.paidAmount || 0), 0);
                const totalPending = appointments.reduce((acc, curr) => acc + (curr.price - (curr.paidAmount || 0)), 0);
                const projected = totalCollected + totalPending;
                return { totalCollected, totalPending, projected };
            }, [appointments]);

            // Handlers (Simplificados para versión HTML)
            const handleVoiceCommand = () => {
                if (!('webkitSpeechRecognition' in window)) { alert("Usa Chrome para voz."); return; }
                const recognition = new window.webkitSpeechRecognition();
                recognition.lang = 'es-ES';
                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript.toLowerCase();
                    let found = patients.find(p => text.includes(p.name.toLowerCase()));
                    if (found) {
                        setApptForm(prev => ({ ...prev, patientId: found.id, paidAmount: text.includes("pago") ? 50000 : 0 }));
                        setEditingItem(null); setModalType('appointment'); setIsModalOpen(true);
                    } else { alert("Paciente no encontrado en el audio."); }
                };
                recognition.start();
            };

            // CRUD Handlers
            const handleSavePatient = async (e) => {
                e.preventDefault();
                const pData = { ...patientForm };
                if (dbInstance && user) {
                    const appId = 'rosario-prod';
                    if (editingItem && typeof editingItem.id === 'string') {
                        await fb.updateDoc(fb.doc(dbInstance, 'artifacts', appId, 'public', 'data', 'patients', editingItem.id), pData);
                    } else {
                        await fb.addDoc(fb.collection(dbInstance, 'artifacts', appId, 'public', 'data', 'patients'), { ...pData, createdAt: new Date().toISOString() });
                    }
                }
                // Local update for immediate feedback
                if (editingItem) setPatients(patients.map(p => p.id === editingItem.id ? { ...p, ...pData } : p));
                else setPatients([...patients, { id: Date.now(), ...pData }]);
                closeModal();
            };

            const handleSaveAppt = async (e) => {
                e.preventDefault();
                const patient = patients.find(p => p.id == apptForm.patientId);
                const aData = { ...apptForm, patientName: patient.name, price: Number(apptForm.price), paidAmount: Number(apptForm.paidAmount) };
                
                // Pack Logic
                const service = SERVICE_TYPES.find(s => s.label === apptForm.type);
                
                // Si es nuevo Pack, sumar créditos
                if (!editingItem && service.isPackSale) {
                     const updatedCredits = (patient.packCredits || 0) + 3;
                     setPatients(prev => prev.map(p => p.id === patient.id ? {...p, packCredits: updatedCredits} : p));
                }
                // Si es uso de Pack, restar créditos
                if (!editingItem && service.isPackUsage) {
                     const updatedCredits = (patient.packCredits || 0) - 1;
                     setPatients(prev => prev.map(p => p.id === patient.id ? {...p, packCredits: updatedCredits} : p));
                }

                if (dbInstance && user) {
                    const appId = 'rosario-prod';
                    if (editingItem && typeof editingItem.id === 'string') {
                        await fb.updateDoc(fb.doc(dbInstance, 'artifacts', appId, 'public', 'data', 'appointments', editingItem.id), aData);
                    } else {
                        await fb.addDoc(fb.collection(dbInstance, 'artifacts', appId, 'public', 'data', 'appointments'), { ...aData, createdAt: new Date().toISOString() });
                    }
                }
                
                if (editingItem) setAppointments(appointments.map(a => a.id === editingItem.id ? { ...a, ...aData } : a));
                else setAppointments([...appointments, { id: Date.now(), ...aData }]);
                closeModal();
            };

            const handleDelete = (id, type) => {
                if(!confirm("¿Eliminar?")) return;
                if(type === 'appt') setAppointments(prev => prev.filter(a => a.id !== id));
                if(type === 'patient') setPatients(prev => prev.filter(p => p.id !== id));
                // Add DB delete logic here if connected
            };

            const closeModal = () => { setIsModalOpen(false); setEditingItem(null); };

            // Render del Modal
            const renderModal = () => {
                if (!isModalOpen) return null;
                return (
                    <div className="fixed inset-0 bg-brand-dark/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl relative animate-scale-in border border-white/50 max-h-[90vh] overflow-y-auto">
                            <button onClick={closeModal} className="absolute top-4 right-4 text-gray-400 hover:text-brand-dark"><X size={24}/></button>
                            
                            {modalType === 'patient' ? (
                                <form onSubmit={handleSavePatient} className="space-y-4">
                                    <h3 className="font-serif text-2xl mb-4 text-brand-dark">{editingItem ? 'Editar Paciente' : 'Nuevo Paciente'}</h3>
                                    <div><label className="block text-xs font-bold uppercase text-gray-400 mb-1">Nombre</label><input required type="text" className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-brand-mocha" value={patientForm.name} onChange={e => setPatientForm({...patientForm, name: e.target.value})} /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-xs font-bold uppercase text-gray-400 mb-1">Género</label><select className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3" value={patientForm.gender} onChange={e => setPatientForm({...patientForm, gender: e.target.value})}><option value="F">Femenino</option><option value="M">Masculino</option></select></div>
                                        <div><label className="block text-xs font-bold uppercase text-gray-400 mb-1">Sistema</label><select className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3" value={patientForm.system} onChange={e => setPatientForm({...patientForm, system: e.target.value})}><option value="Isapre">Isapre</option><option value="Fonasa">Fonasa</option><option value="Particular">Particular</option></select></div>
                                    </div>
                                    {editingItem && (<div><label className="block text-xs font-bold uppercase text-gray-400 mb-1">Créditos Pack (Manual)</label><input type="number" className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none" value={patientForm.packCredits} onChange={e => setPatientForm({...patientForm, packCredits: parseInt(e.target.value)})} /></div>)}
                                    <button type="submit" className="w-full bg-brand-dark text-white py-3 rounded-xl font-bold hover:bg-brand-mocha transition-all mt-4">{editingItem ? 'Actualizar' : 'Guardar'}</button>
                                </form>
                            ) : (
                                <form onSubmit={handleSaveAppt} className="space-y-4">
                                    <h3 className="font-serif text-2xl mb-4 text-brand-dark">{editingItem ? 'Editar Cita' : 'Nueva Cita'}</h3>
                                    <div>
                                        <label className="block text-xs font-bold uppercase text-gray-400 mb-1">Paciente</label>
                                        <select required disabled={!!editingItem} className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none disabled:bg-gray-100" value={apptForm.patientId} onChange={e => setApptForm({...apptForm, patientId: e.target.value})}>
                                            <option value="">Seleccionar...</option>
                                            {patients.map(p => <option key={p.id} value={p.id}>{p.name} {p.packCredits > 0 ? `(Pack: ${p.packCredits})` : ''}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold uppercase text-gray-400 mb-1">Tipo de Servicio</label>
                                        <select className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none" value={apptForm.type} onChange={(e) => {
                                            const sel = SERVICE_TYPES.find(s => s.label === e.target.value);
                                            setApptForm(prev => ({ ...prev, type: sel.label, price: sel.price, paidAmount: !editingItem ? 0 : prev.paidAmount }));
                                        }}>
                                            {SERVICE_TYPES.map(s => <option key={s.label} value={s.label}>{s.label} - {formatCurrency(s.price)}</option>)}
                                        </select>
                                    </div>
                                    
                                    {apptForm.type.includes('Pack Lanzamiento') && (
                                        <div className="bg-brand-mocha/10 p-3 rounded-xl border border-brand-mocha/20 text-xs">
                                            <p className="font-bold mb-1">Pack = 3 Sesiones</p>
                                            <p>Abono mín: 50% ($65.000). Saldo pendiente se verá en dashboard.</p>
                                        </div>
                                    )}
                                    {apptForm.type.includes('Uso de Pack') && <div className="bg-green-50 p-3 rounded-xl border border-green-100 text-green-700 text-xs font-bold">Descuenta 1 sesión del saldo. Costo $0.</div>}

                                    {!apptForm.type.includes('Pack') && (
                                        <div><label className="block text-xs font-bold uppercase text-gray-400 mb-1">Monto Pagado</label><input type="number" className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none" value={apptForm.paidAmount} onChange={e => setApptForm({...apptForm, paidAmount: parseInt(e.target.value)})} /></div>
                                    )}
                                    {apptForm.type.includes('Pack Lanzamiento') && (
                                        <div><label className="block text-xs font-bold uppercase text-gray-400 mb-1">Monto Pagado (Abono)</label><input type="number" className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none" value={apptForm.paidAmount} onChange={e => setApptForm({...apptForm, paidAmount: parseInt(e.target.value)})} /></div>
                                    )}

                                    <div>
                                        <label className="block text-xs font-bold uppercase text-gray-400 mb-1">Fecha</label>
                                        <input required type="date" className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none" value={apptForm.date} onChange={e => setApptForm({...apptForm, date: e.target.value})} />
                                    </div>
                                    <button type="submit" className="w-full bg-brand-mahogany text-white py-3 rounded-xl font-bold hover:bg-opacity-90 transition-all mt-4">{editingItem ? 'Actualizar' : 'Confirmar'}</button>
                                </form>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen flex flex-col md:flex-row text-brand-dark">
                    {/* SIDEBAR */}
                    <aside className="w-full md:w-64 bg-brand-dark text-white p-6 md:h-screen sticky top-0 flex flex-col justify-between z-20 shadow-2xl">
                        <div>
                            <h1 className="font-serif text-2xl mb-1 text-brand-mocha">Rosario Garrido.</h1>
                            <p className="text-xs text-gray-400 mb-10 tracking-widest uppercase">Admin Panel</p>
                            <nav className="space-y-2">
                                <button onClick={() => setView('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === 'dashboard' ? 'bg-brand-mocha' : 'hover:bg-white/10'}`}><LayoutDashboard size={20} /> Dashboard</button>
                                <button onClick={() => setView('patients')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === 'patients' ? 'bg-brand-mocha' : 'hover:bg-white/10'}`}><Users size={20} /> Pacientes</button>
                                <button onClick={() => setView('calendar')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === 'calendar' ? 'bg-brand-mocha' : 'hover:bg-white/10'}`}><Calendar size={20} /> Agenda</button>
                            </nav>
                        </div>
                        <div className="pt-6 border-t border-gray-700">
                            <button onClick={handleVoiceCommand} className={`w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl font-bold ${isListening ? 'bg-red-500 animate-pulse-ring' : 'bg-gray-800'}`}>
                                {isListening ? <><MicOff size={18} /> Escuchando...</> : <><Mic size={18} /> Voz (Beta)</>}
                            </button>
                        </div>
                    </aside>

                    {/* MAIN */}
                    <main className="flex-1 p-6 md:p-10 overflow-y-auto">
                        <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                            <h2 className="text-3xl font-serif text-brand-dark">
                                {view === 'dashboard' && 'Visión General'}
                                {view === 'patients' && 'Gestión de Pacientes'}
                                {view === 'calendar' && 'Agenda & Finanzas'}
                            </h2>
                            <button onClick={() => { setEditingItem(null); setModalType('appointment'); setIsModalOpen(true); }} className="bg-brand-mahogany text-white px-6 py-3 rounded-full text-sm font-bold shadow-lg flex items-center gap-2 hover:scale-105 transition-transform"><Plus size={18} /> <span>Nueva Cita</span></button>
                        </header>

                        {/* DASHBOARD */}
                        {view === 'dashboard' && (
                            <div className="space-y-8 animate-fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <Card title="En Caja (Real)" value={formatCurrency(financials.totalCollected)} subtext="Dinero recibido" icon={CheckCircle} colorClass="bg-green-600" />
                                    <Card title="Por Cobrar" value={formatCurrency(financials.totalPending)} subtext="Saldo pendiente" icon={Clock} colorClass="bg-brand-mahogany" />
                                    <Card title="Proyección Total" value={formatCurrency(financials.projected)} subtext="Potencial mes" icon={TrendingUp} colorClass="bg-brand-lavender" />
                                </div>
                                <div className="bg-white/60 backdrop-blur-xl border border-white rounded-3xl p-8 shadow-sm overflow-x-auto">
                                    <h3 className="font-serif text-xl mb-6">Últimos Movimientos</h3>
                                    <table className="w-full text-left text-sm">
                                        <thead className="text-gray-400 border-b border-gray-200"><tr><th className="pb-3">Fecha</th><th className="pb-3">Paciente</th><th className="pb-3">Estado</th></tr></thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {appointments.slice(0, 5).map(a => (
                                                <tr key={a.id} className="hover:bg-white/50"><td className="py-3">{a.date}</td><td className="py-3 font-bold">{a.patientName}</td><td className="py-3"><span className={`px-2 py-1 rounded-full text-xs font-bold border ${getStatus(a.price, a.paidAmount).color}`}>{getStatus(a.price, a.paidAmount).label}</span></td></tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* PACIENTES */}
                        {view === 'patients' && (
                            <div className="bg-white/60 backdrop-blur-xl border border-white rounded-3xl p-8 shadow-sm animate-fade-in">
                                <div className="flex justify-between mb-6">
                                    <h3 className="font-serif text-xl">Listado</h3>
                                    <button onClick={() => { setEditingItem(null); setModalType('patient'); setIsModalOpen(true); }} className="text-brand-mocha font-bold text-sm hover:underline flex items-center gap-1"><UserPlus size={16} /> Agregar</button>
                                </div>
                                <div className="grid grid-cols-1 gap-4">
                                    {patients.map(p => {
                                        const status = getPatientStatus(p, appointments);
                                        return (
                                            <div key={p.id} className="bg-white p-4 rounded-2xl border border-gray-100 flex justify-between items-center hover:shadow-md transition-all">
                                                <div className="flex items-center gap-4">
                                                    <div className={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold ${p.gender === 'F' ? 'bg-brand-lavender' : 'bg-brand-mocha'}`}>{p.name.charAt(0)}</div>
                                                    <div>
                                                        <p className="font-bold text-lg">{p.name}</p>
                                                        <div className="flex flex-wrap gap-2 mt-1">
                                                            <span className="bg-gray-100 px-2 py-0.5 rounded text-xs text-gray-500">{p.system}</span>
                                                            <span className={`text-xs flex items-center gap-1 ${status.color}`}>
                                                                {status.isPack ? <CreditCard size={12}/> : (status.action ? <AlertTriangle size={12}/> : <CheckCircle size={12}/>)}
                                                                {status.label}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => { setEditingItem(p); setPatientForm(p); setModalType('patient'); setIsModalOpen(true); }} className="text-gray-300 hover:text-brand-mocha"><Edit2 size={18}/></button>
                                                    <button onClick={() => handleDelete(p.id, 'patient')} className="text-gray-300 hover:text-red-500"><Trash2 size={18}/></button>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        )}

                        {/* CALENDARIO */}
                        {view === 'calendar' && (
                            <div className="bg-white/60 backdrop-blur-xl border border-white rounded-3xl p-8 shadow-sm animate-fade-in overflow-x-auto">
                                <h3 className="font-serif text-xl mb-6">Historial</h3>
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-gray-50/50"><tr><th className="p-3">Fecha</th><th className="p-3">Paciente</th><th className="p-3">Servicio</th><th className="p-3">Balance</th><th className="p-3">Estado</th><th className="p-3 text-right">Acción</th></tr></thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {appointments.map(appt => {
                                            const st = getStatus(appt.price, appt.paidAmount);
                                            return (
                                                <tr key={appt.id} className="hover:bg-white transition-colors">
                                                    <td className="p-3 text-gray-500">{appt.date}</td>
                                                    <td className="p-3 font-bold">{appt.patientName} {appt.type.includes('Pack') && <span className="ml-1 text-[10px] bg-brand-mocha text-white px-1 rounded">PACK</span>}</td>
                                                    <td className="p-3 text-sm text-gray-600">{appt.type}</td>
                                                    <td className="p-3 font-mono">
                                                        <div>{formatCurrency(appt.price)}</div>
                                                        {appt.price > appt.paidAmount && appt.price > 0 && <div className="text-[10px] text-red-500 font-bold">Debe: {formatCurrency(appt.price - appt.paidAmount)}</div>}
                                                    </td>
                                                    <td className="p-3"><span className={`px-2 py-1 rounded-full text-xs font-bold border ${st.color}`}>{st.label}</span></td>
                                                    <td className="p-3 text-right flex justify-end gap-2">
                                                        <button onClick={() => { setEditingItem(appt); setApptForm(appt); setModalType('appointment'); setIsModalOpen(true); }} className="text-gray-300 hover:text-brand-mocha"><Edit2 size={16}/></button>
                                                        <button onClick={() => handleDelete(appt.id, 'appt')} className="text-gray-300 hover:text-red-500"><Trash2 size={16}/></button>
                                                    </td>
                                                </tr>
                                            )
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {/* RENDER MODAL */}
                        {renderModal()}
                    </main>
                </div>
            );
        }

        // Renderizar React
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
