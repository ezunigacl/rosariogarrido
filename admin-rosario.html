import React, { useState, useEffect, useMemo } from 'react';
import { Users, Calendar, DollarSign, Plus, CheckCircle, Clock, Trash2, LayoutDashboard, UserPlus, CreditCard, AlertCircle, TrendingUp, CalendarDays, Edit2, X, AlertTriangle, Mic, MicOff } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, getDoc } from 'firebase/firestore';

// --- CONFIGURACIÓN E INICIALIZACIÓN ---

let app, auth, db;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'rosario-admin-pro-v5-voice';

try {
    if (typeof __firebase_config !== 'undefined') {
        const firebaseConfig = JSON.parse(__firebase_config);
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
    }
} catch (e) {
    console.log("Modo Demo: Configuración de Firebase no detectada.");
}

// Estilos
const GlobalStyles = () => (
  <style>{`
    @import url('https://fonts.googleapis.com/css2?family=Instrument+Serif:ital,wght@0,400;1,400&family=Manrope:wght@300;400;500;600;700&display=swap');
    
    body { font-family: 'Manrope', sans-serif; background-color: #FAF9F6; color: #1A1918; }
    .font-serif { font-family: 'Instrument Serif', serif; }
    
    /* Animaciones */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    
    .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    .animate-scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .animate-pulse-ring { animation: pulse-ring 2s infinite; }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #FAF9F6; }
    ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #A47864; }
  `}</style>
);

// --- 10 EJEMPLOS DE CASUÍSTICA REAL ---
const MOCK_PATIENTS = [
    { id: 1, name: "Valentina Paz", gender: "F", system: "Isapre", packCredits: 3 }, // Pack nuevo
    { id: 2, name: "Benjamín Soto", gender: "M", system: "Fonasa", packCredits: 2 }, // Pack en uso
    { id: 3, name: "Matías Araya", gender: "M", system: "Isapre", packCredits: 0 }, // Normal al día
    { id: 4, name: "Isidora Muñoz", gender: "F", system: "Particular", packCredits: 0 }, // Debe agendar
    { id: 5, name: "Lucas Silva", gender: "M", system: "Fonasa", packCredits: 0 }, // Normal antiguo
    { id: 6, name: "Emilia Rojas", gender: "F", system: "Isapre", packCredits: 0 }, // Pack terminado
    { id: 7, name: "Joaquín Pérez", gender: "M", system: "Isapre", packCredits: 0 }, // Debe
    { id: 8, name: "Florencia Díaz", gender: "F", system: "Particular", packCredits: 3 }, // Pack nuevo
    { id: 9, name: "Agustín Vargas", gender: "M", system: "Fonasa", packCredits: 0 },
    { id: 10, name: "Catalina Bravo", gender: "F", system: "Isapre", packCredits: 0 }
];

const MOCK_APPOINTMENTS = [
    { id: 101, patientId: 1, patientName: "Valentina Paz", type: "Pack Lanzamiento (Compra)", price: 130000, paidAmount: 65000, date: "2026-02-20" },
    { id: 102, patientId: 2, patientName: "Benjamín Soto", type: "Pack Lanzamiento (Compra)", price: 130000, paidAmount: 130000, date: "2026-02-18" },
    { id: 103, patientId: 2, patientName: "Benjamín Soto", type: "Uso de Pack (Sesión)", price: 0, paidAmount: 0, date: "2026-02-25" },
    { id: 104, patientId: 3, patientName: "Matías Araya", type: "Online (Nuevo)", price: 50000, paidAmount: 50000, date: "2026-02-24" },
    { id: 105, patientId: 4, patientName: "Isidora Muñoz", type: "Presencial Santiago", price: 50000, paidAmount: 50000, date: "2026-01-15" }, 
    { id: 106, patientId: 5, patientName: "Lucas Silva", type: "Online Mostazal (Antiguo)", price: 35000, paidAmount: 35000, date: "2026-02-22" },
    { id: 107, patientId: 6, patientName: "Emilia Rojas", type: "Uso de Pack (Sesión)", price: 0, paidAmount: 0, date: "2026-02-21" },
    { id: 108, patientId: 7, patientName: "Joaquín Pérez", type: "Online (Nuevo)", price: 50000, paidAmount: 25000, date: "2026-02-23" },
    { id: 109, patientId: 8, patientName: "Florencia Díaz", type: "Pack Lanzamiento (Compra)", price: 130000, paidAmount: 130000, date: "2026-02-19" },
    { id: 110, patientId: 9, patientName: "Agustín Vargas", type: "Presencial Santiago", price: 50000, paidAmount: 50000, date: "2026-02-27" }
];

// --- UTILIDADES ---
const formatCurrency = (amount) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(amount);

const getStatus = (price, paid) => {
    if (price === 0) return { label: 'Pack Uso', color: 'bg-blue-50 text-blue-700 border-blue-100' };
    if (paid >= price) return { label: 'Pagado', color: 'bg-green-100 text-green-700 border-green-200' };
    if (paid > 0) return { label: 'Abonado', color: 'bg-yellow-100 text-yellow-700 border-yellow-200' };
    return { label: 'Pendiente', color: 'bg-red-50 text-red-600 border-red-100' };
};

const getPatientStatus = (patient, appointments) => {
    const patientAppts = appointments.filter(a => a.patientId === patient.id);
    if (patientAppts.length === 0) return { label: 'Nuevo / Sin Citas', color: 'text-gray-400', action: true };
    const sortedAppts = [...patientAppts].sort((a, b) => new Date(b.date) - new Date(a.date));
    const lastAppt = sortedAppts[0];
    const today = new Date().toISOString().split('T')[0];
    if (patient.packCredits > 0) {
        return { label: `${patient.packCredits} Sesiones Pendientes`, color: 'text-brand-mocha font-bold', isPack: true };
    }
    if (lastAppt.date >= today) {
        return { label: `Agendado: ${lastAppt.date.slice(5)}`, color: 'text-green-600 font-medium', action: false };
    }
    return { label: '⚠️ Agendar (Venta)', color: 'text-red-500 font-bold', action: true };
};

// --- COMPONENTES UI ---

const Card = ({ title, value, subtext, icon: Icon, colorClass }) => (
    <div className="bg-white/40 backdrop-blur-md border border-white/50 rounded-3xl p-6 shadow-lg flex items-start justify-between transform transition hover:-translate-y-1">
        <div>
            <p className="text-gray-500 text-sm font-bold uppercase tracking-wider mb-1">{title}</p>
            <h3 className="text-3xl font-serif text-[#1A1918]">{value}</h3>
            <p className="text-xs text-gray-400 mt-2">{subtext}</p>
        </div>
        <div className={`p-3 rounded-2xl ${colorClass} text-white shadow-md`}>
            <Icon size={24} />
        </div>
    </div>
);

const AppointmentRow = ({ appt, onDelete, onEdit }) => {
    const status = getStatus(appt.price, appt.paidAmount);
    return (
        <tr className="hover:bg-white transition-colors group border-b border-gray-50 last:border-0">
            <td className="p-3 text-gray-500 font-medium">{appt.date}</td>
            <td className="p-3 font-bold text-[#1A1918]">
                {appt.patientName}
                {appt.type.includes('Pack') && <span className="ml-2 text-[10px] bg-[#A47864] text-white px-1.5 py-0.5 rounded-full tracking-wide">PACK</span>}
            </td>
            <td className="p-3 text-sm text-gray-600">{appt.type}</td>
            <td className="p-3 font-mono text-gray-600">
                <div className="flex flex-col leading-tight">
                    <span>{formatCurrency(appt.price)}</span>
                    {appt.price > appt.paidAmount && appt.price > 0 && (
                        <span className="text-[10px] text-red-500 font-bold">Debe: {formatCurrency(appt.price - appt.paidAmount)}</span>
                    )}
                </div>
            </td>
            <td className="p-3">
                <span className={`px-3 py-1 rounded-full text-xs font-bold border ${status.color}`}>
                    {status.label}
                </span>
            </td>
            <td className="p-3 text-right">
                <div className="flex justify-end gap-2">
                    <button onClick={() => onEdit(appt)} className="text-gray-300 hover:text-[#A47864] transition p-2 rounded-full hover:bg-[#A47864]/10" title="Editar Pago">
                        <Edit2 size={16} />
                    </button>
                    <button onClick={() => onDelete(appt.id)} className="text-gray-300 hover:text-red-500 transition p-2 rounded-full hover:bg-red-50" title="Eliminar">
                        <Trash2 size={16} />
                    </button>
                </div>
            </td>
        </tr>
    );
};

// --- APP PRINCIPAL ---

export default function App() {
    const [user, setUser] = useState(null);
    const [view, setView] = useState('dashboard');
    const [patients, setPatients] = useState(MOCK_PATIENTS);
    const [appointments, setAppointments] = useState(MOCK_APPOINTMENTS);
    
    // UI States
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [modalType, setModalType] = useState('');
    const [editingItem, setEditingItem] = useState(null);
    
    // Voice State
    const [isListening, setIsListening] = useState(false);
    
    // Forms
    const [patientForm, setPatientForm] = useState({ name: '', gender: 'F', system: 'Isapre', packCredits: 0 });
    const [apptForm, setApptForm] = useState({ patientId: '', type: 'Online (Nuevo)', date: '', price: 50000, paidAmount: 0 });

    const SERVICE_TYPES = [
        { label: "Online (Nuevo)", price: 50000 },
        { label: "Presencial Santiago", price: 50000 },
        { label: "Online Mostazal (Antiguo)", price: 35000 },
        { label: "Pack Lanzamiento (Compra)", price: 130000, isPackSale: true },
        { label: "Uso de Pack (Sesión)", price: 0, isPackUsage: true },
    ];

    // --- FIREBASE INIT ---
    useEffect(() => {
        if (auth) {
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };
            initAuth();
            const unsubscribe = onAuthStateChanged(auth, setUser);
            return () => unsubscribe();
        }
    }, []);

    // --- LISTENERS ---
    useEffect(() => {
        if (!user || !db) return;
        const unsubP = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'patients'), orderBy('name')), 
            (s) => { if (!s.empty) setPatients(s.docs.map(d => ({ id: d.id, ...d.data() }))); }
        );
        const unsubA = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'appointments'), orderBy('date', 'desc')), 
            (s) => { if (!s.empty) setAppointments(s.docs.map(d => ({ id: d.id, ...d.data() }))); }
        );
        return () => { unsubP(); unsubA(); };
    }, [user]);

    // --- CÁLCULOS FINANCIEROS ---
    const financials = useMemo(() => {
        const totalCollected = appointments.reduce((acc, curr) => acc + (curr.paidAmount || 0), 0);
        const totalPending = appointments.reduce((acc, curr) => acc + (curr.price - (curr.paidAmount || 0)), 0);
        const projected = totalCollected + totalPending;
        const activePatients = patients.filter(p => {
            const status = getPatientStatus(p, appointments);
            return !status.action || status.isPack;
        }).length;
        return { totalCollected, totalPending, projected, activePatients };
    }, [appointments, patients]);

    // --- RECONOCIMIENTO DE VOZ (SIMULADO / NATIVO) ---
    
    const handleVoiceCommand = () => {
        if (!('webkitSpeechRecognition' in window)) {
            alert("Tu navegador no soporta reconocimiento de voz nativo. Intenta en Chrome.");
            return;
        }

        const recognition = new window.webkitSpeechRecognition();
        recognition.lang = 'es-ES';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = () => setIsListening(true);
        
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript.toLowerCase();
            console.log("Comando de voz:", transcript);
            processVoiceCommand(transcript);
            setIsListening(false);
        };

        recognition.onerror = () => setIsListening(false);
        recognition.onend = () => setIsListening(false);

        recognition.start();
    };

    const processVoiceCommand = (text) => {
        // Lógica simple de procesamiento de lenguaje natural
        // Ejemplo: "Agendar a Valentina Paz para el 20 de febrero pago 50 mil"
        
        let foundPatient = patients.find(p => text.includes(p.name.toLowerCase()));
        
        if (foundPatient) {
            // Si encuentra paciente, abrir modal de cita con ese paciente
            setApptForm(prev => ({
                ...prev,
                patientId: foundPatient.id,
                // Intento básico de extraer pago (buscar número después de "pago")
                paidAmount: text.includes("pagado") || text.includes("pago") ? 50000 : 0 
            }));
            setEditingItem(null);
            setModalType('appointment');
            setIsModalOpen(true);
            alert(`Comando reconocido: Agendando para ${foundPatient.name}`);
        } else {
            alert("No entendí el nombre del paciente. Intenta decir el nombre completo registrado.");
        }
    };

    // --- HANDLERS ---

    const openEditPatient = (patient) => {
        setEditingItem(patient);
        setPatientForm(patient);
        setModalType('patient');
        setIsModalOpen(true);
    };

    const openEditAppt = (appt) => {
        setEditingItem(appt);
        setApptForm(appt);
        setModalType('appointment');
        setIsModalOpen(true);
    };

    const handleServiceChange = (e) => {
        const selected = SERVICE_TYPES.find(s => s.label === e.target.value);
        const isNew = !editingItem;
        setApptForm(prev => ({ 
            ...prev, 
            type: selected.label, 
            price: selected.price,
            paidAmount: isNew ? 0 : prev.paidAmount 
        }));
    };

    const handleSavePatient = async (e) => {
        e.preventDefault();
        const pData = { ...patientForm };
        if (db && user) {
            if (editingItem && typeof editingItem.id === 'string') {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'patients', editingItem.id), pData);
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'patients'), { ...pData, createdAt: new Date().toISOString() });
            }
        } 
        if (editingItem) setPatients(patients.map(p => p.id === editingItem.id ? { ...p, ...pData } : p));
        else setPatients([...patients, { id: Date.now(), ...pData }]);
        closeModal();
    };

    const handleSaveAppointment = async (e) => {
        e.preventDefault();
        const service = SERVICE_TYPES.find(s => s.label === apptForm.type);
        const patient = patients.find(p => p.id == apptForm.patientId);
        if (!patient) return;

        if (!editingItem || (editingItem && editingItem.type !== apptForm.type)) {
            if (service.isPackUsage && (patient.packCredits || 0) <= 0) {
                alert("¡Atención! Este paciente NO tiene sesiones de Pack disponibles.");
                return;
            }
            if (service.isPackSale && apptForm.paidAmount < (apptForm.price * 0.5)) {
                alert("Para reservar el Pack, el abono mínimo obligatorio es del 50% ($65.000).");
                return;
            }
        }

        const aData = { 
            ...apptForm, 
            patientName: patient.name,
            price: Number(apptForm.price),
            paidAmount: Number(apptForm.paidAmount)
        };

        if (!editingItem) {
            let updatedCredits = patient.packCredits || 0;
            if (service.isPackSale) updatedCredits += 3;
            if (service.isPackUsage) updatedCredits -= 1;
            
            if (db && user && typeof patient.id === 'string') {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'patients', patient.id), { packCredits: updatedCredits });
            } else {
                setPatients(patients.map(p => p.id === patient.id ? { ...p, packCredits: updatedCredits } : p));
            }
        }

        if (db && user) {
            if (editingItem && typeof editingItem.id === 'string') {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'appointments', editingItem.id), aData);
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'appointments'), { ...aData, createdAt: new Date().toISOString() });
            }
        } else {
            if (editingItem) setAppointments(appointments.map(a => a.id === editingItem.id ? { ...a, ...aData } : a));
            else setAppointments([...appointments, { id: Date.now(), ...aData }]);
        }
        closeModal();
    };

    const handleDeleteAppt = async (id) => {
        if(!confirm("¿Eliminar registro?")) return;
        if (typeof id === 'string' && db && user) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'appointments', id));
        setAppointments(prev => prev.filter(a => a.id !== id));
    };
    
    const handleDeletePatient = async (id) => {
        if(!confirm("¿Eliminar paciente?")) return;
        if (typeof id === 'string' && db && user) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'patients', id));
        setPatients(prev => prev.filter(p => p.id !== id));
    };

    const closeModal = () => {
        setIsModalOpen(false);
        setEditingItem(null);
        setPatientForm({ name: '', gender: 'F', system: 'Isapre', packCredits: 0 });
        setApptForm({ patientId: '', type: 'Online (Nuevo)', date: '', price: 50000, paidAmount: 0 });
    };

    // --- RENDER ---

    return (
        <div className="min-h-screen flex flex-col md:flex-row text-[#1A1918]">
            <GlobalStyles />
            
            {/* SIDEBAR */}
            <aside className="w-full md:w-64 bg-[#1A1918] text-white p-6 md:h-screen sticky top-0 flex flex-col justify-between z-20 shadow-2xl">
                <div>
                    <h1 className="font-serif text-2xl mb-1 text-[#A47864]">Rosario Garrido.</h1>
                    <p className="text-xs text-gray-400 mb-10 tracking-widest uppercase">Admin Panel</p>
                    <nav className="space-y-2">
                        <button onClick={() => setView('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === 'dashboard' ? 'bg-[#A47864] text-white shadow-lg' : 'text-gray-400 hover:bg-white/10'}`}><LayoutDashboard size={20} /> Dashboard</button>
                        <button onClick={() => setView('patients')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === 'patients' ? 'bg-[#A47864] text-white shadow-lg' : 'text-gray-400 hover:bg-white/10'}`}><Users size={20} /> Pacientes</button>
                        <button onClick={() => setView('calendar')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === 'calendar' ? 'bg-[#A47864] text-white shadow-lg' : 'text-gray-400 hover:bg-white/10'}`}><Calendar size={20} /> Agenda</button>
                    </nav>
                </div>
                
                {/* Voice Status Indicator */}
                <div className="pt-6 border-t border-gray-700">
                    <button 
                        onClick={handleVoiceCommand}
                        className={`w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl transition-all font-bold ${isListening ? 'bg-red-500 text-white animate-pulse-ring' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}`}
                    >
                        {isListening ? <><MicOff size={18} /> Escuchando...</> : <><Mic size={18} /> Voz (Beta)</>}
                    </button>
                    <p className="text-[10px] text-gray-500 mt-2 text-center">Ej: "Agendar a Valentina"</p>
                </div>
            </aside>

            {/* MAIN */}
            <main className="flex-1 p-6 md:p-10 overflow-y-auto">
                <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                    <h2 className="text-3xl font-serif text-[#1A1918]">
                        {view === 'dashboard' && 'Visión General'}
                        {view === 'patients' && 'Gestión de Pacientes'}
                        {view === 'calendar' && 'Agenda & Finanzas'}
                    </h2>
                    <button onClick={() => { setEditingItem(null); setModalType('appointment'); setIsModalOpen(true); }} className="bg-[#7A2E2A] text-white px-6 py-3 rounded-full text-sm font-bold shadow-lg hover:bg-opacity-90 flex items-center gap-2 transition-transform hover:scale-105">
                        <Plus size={18} /> <span>Nueva Cita</span>
                    </button>
                </header>

                {/* VISTA DASHBOARD */}
                {view === 'dashboard' && (
                    <div className="space-y-8 animate-fade-in">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <Card title="En Caja (Real)" value={formatCurrency(financials.totalCollected)} subtext="Dinero efectivamente recibido" icon={CheckCircle} colorClass="bg-green-600" />
                            <Card title="Por Cobrar" value={formatCurrency(financials.totalPending)} subtext="Saldo pendiente de citas/packs" icon={Clock} colorClass="bg-[#7A2E2A]" />
                            <Card title="Proyección Total" value={formatCurrency(financials.projected)} subtext="Potencial total del periodo" icon={TrendingUp} colorClass="bg-[#A78BFA]" />
                        </div>

                        <div className="bg-white/60 backdrop-blur-xl border border-white rounded-3xl p-8 shadow-sm">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-serif text-xl flex items-center gap-2"><CalendarDays size={20} className="text-[#A47864]" /> Últimos Movimientos</h3>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="text-gray-400 border-b border-gray-200">
                                        <tr><th className="pb-3 font-normal">Fecha Atención</th><th className="pb-3 font-normal">Paciente</th><th className="pb-3 font-normal">Detalle</th><th className="pb-3 font-normal">Estado</th><th className="pb-3 font-normal text-right">Acción</th></tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {appointments.slice(0, 10).map(appt => (
                                            <AppointmentRow key={appt.id} appt={appt} onDelete={handleDeleteAppt} onEdit={openEditAppt} />
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                )}

                {/* VISTA PACIENTES */}
                {view === 'patients' && (
                    <div className="bg-white/60 backdrop-blur-xl border border-white rounded-3xl p-8 shadow-sm animate-fade-in">
                        <div className="flex justify-between mb-6">
                            <h3 className="font-serif text-xl">Listado de Pacientes & Estado</h3>
                            <button onClick={() => { setEditingItem(null); setModalType('patient'); setIsModalOpen(true); }} className="text-[#A47864] font-bold text-sm hover:underline flex items-center gap-1"><UserPlus size={16} /> Agregar</button>
                        </div>
                        <div className="grid grid-cols-1 gap-4">
                            {patients.map(p => {
                                const status = getPatientStatus(p, appointments);
                                return (
                                    <div key={p.id} className="bg-white p-4 rounded-2xl border border-gray-100 flex justify-between items-center hover:shadow-md transition-all">
                                        <div className="flex items-center gap-4">
                                            <div className={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg ${p.gender === 'F' ? 'bg-[#A78BFA]' : 'bg-[#A47864]'}`}>{p.name.charAt(0)}</div>
                                            <div>
                                                <p className="font-bold text-[#1A1918] text-lg">{p.name}</p>
                                                <div className="flex flex-col sm:flex-row gap-2 mt-1">
                                                    <span className="bg-gray-100 px-2 py-0.5 rounded text-xs text-gray-500 w-fit">{p.system}</span>
                                                    <span className={`text-xs flex items-center gap-1 ${status.color}`}>
                                                        {status.isPack ? <CreditCard size={12}/> : (status.action ? <AlertTriangle size={12}/> : <CheckCircle size={12}/>)}
                                                        {status.label}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => openEditPatient(p)} className="text-gray-300 hover:text-[#7A2E2A]"><Edit2 size={18}/></button>
                                            <button onClick={() => handleDeletePatient(p.id)} className="text-gray-300 hover:text-red-500"><Trash2 size={18}/></button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}

                {/* VISTA CALENDARIO */}
                {view === 'calendar' && (
                    <div className="bg-white/60 backdrop-blur-xl border border-white rounded-3xl p-8 shadow-sm animate-fade-in">
                        <h3 className="font-serif text-xl mb-6">Historial Completo</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-gray-50/50">
                                    <tr className="text-gray-400">
                                        <th className="p-3 font-normal">Fecha Atención</th><th className="p-3 font-normal">Paciente</th><th className="p-3 font-normal">Servicio</th><th className="p-3 font-normal">Balance</th><th className="p-3 font-normal">Estado</th><th className="p-3 font-normal text-right">Acción</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {appointments.map(appt => <AppointmentRow key={appt.id} appt={appt} onDelete={handleDeleteAppt} onEdit={openEditAppt} />)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
            </main>

            {/* MODALES */}
            {isModalOpen && (
                <div className="fixed inset-0 bg-[#1A1918]/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl relative animate-scale-in border border-white/50 max-h-[90vh] overflow-y-auto">
                        <button onClick={closeModal} className="absolute top-4 right-4 text-gray-400 hover:text-[#1A1918]"><X size={24}/></button>
                        
                        {modalType === 'patient' ? (
                            <form onSubmit={handleSavePatient} className="space-y-4">
                                <h3 className="font-serif text-2xl mb-4 text-[#1A1918]">{editingItem ? 'Editar Paciente' : 'Nuevo Paciente'}</h3>
                                <div><label className="block text-xs font-bold uppercase text-gray-400 mb-1">Nombre</label><input required type="text" className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-[#A47864]" value={patientForm.name} onChange={e => setPatientForm({...patientForm, name: e.target.value})} /></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-xs font-bold uppercase text-gray-400 mb-1">Género</label><select className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3" value={patientForm.gender} onChange={e => setPatientForm({...patientForm, gender: e.target.value})}><option value="F">Femenino</option><option value="M">Masculino</option></select></div>
                                    <div><label className="block text-xs font-bold uppercase text-gray-400 mb-1">Sistema</label><select className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3" value={patientForm.system} onChange={e => setPatientForm({...patientForm, system: e.target.value})}><option value="Isapre">Isapre</option><option value="Fonasa">Fonasa</option><option value="Particular">Particular</option></select></div>
                                </div>
                                {editingItem && (
                                    <div><label className="block text-xs font-bold uppercase text-gray-400 mb-1">Créditos Pack (Manual)</label><input type="number" className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none" value={patientForm.packCredits} onChange={e => setPatientForm({...patientForm, packCredits: parseInt(e.target.value)})} /></div>
                                )}
                                <button type="submit" className="w-full bg-[#1A1918] text-white py-3 rounded-xl font-bold hover:bg-[#A47864] transition-all mt-4">{editingItem ? 'Actualizar' : 'Guardar'}</button>
                            </form>
                        ) : (
                            <form onSubmit={handleSaveAppointment} className="space-y-4">
                                <h3 className="font-serif text-2xl mb-4 text-[#1A1918]">{editingItem ? 'Editar Cita/Cobro' : 'Agendar / Cobrar'}</h3>
                                
                                <div>
                                    <label className="block text-xs font-bold uppercase text-gray-400 mb-1">Paciente</label>
                                    <select required disabled={!!editingItem} className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none disabled:bg-gray-100 disabled:text-gray-500"
                                        value={apptForm.patientId} onChange={e => {
                                            const pid = e.target.value;
                                            setApptForm({...apptForm, patientId: pid});
                                        }}>
                                        <option value="">Seleccionar...</option>
                                        {patients.map(p => <option key={p.id} value={p.id}>{p.name} {p.packCredits > 0 ? `(Pack: ${p.packCredits})` : ''}</option>)}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold uppercase text-gray-400 mb-1">Tipo de Servicio</label>
                                    <select className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none"
                                        value={apptForm.type} onChange={handleServiceChange}>
                                        {SERVICE_TYPES.map(s => <option key={s.label} value={s.label}>{s.label} - {formatCurrency(s.price)}</option>)}
                                    </select>
                                </div>

                                {apptForm.type.includes('Pack Lanzamiento') && (
                                    <div className="bg-[#A47864]/10 p-3 rounded-xl border border-[#A47864]/20">
                                        <p className="text-xs text-[#A47864] font-bold mb-2 flex gap-1"><AlertCircle size={12}/> Abono Obligatorio (Mín 50%)</p>
                                        <label className="block text-xs font-bold uppercase text-gray-500 mb-1">¿Cuánto pagó el cliente?</label>
                                        <input type="number" className="w-full bg-white border border-[#A47864] rounded-lg p-2 font-mono text-lg" 
                                            placeholder="Mínimo 65000"
                                            value={apptForm.paidAmount || ''} 
                                            onChange={e => setApptForm({...apptForm, paidAmount: parseInt(e.target.value)})} />
                                        <p className="text-[10px] text-gray-400 mt-1 text-right">Saldo pendiente: {formatCurrency(Math.max(0, 130000 - (apptForm.paidAmount || 0)))}</p>
                                    </div>
                                )}

                                {apptForm.type.includes('Uso de Pack') && (
                                    <div className="bg-green-50 p-3 rounded-xl border border-green-100 text-green-700 text-xs">
                                        <p className="font-bold flex gap-1"><CheckCircle size={12}/> Costo $0</p>
                                        <p>Se descontará 1 sesión del saldo del paciente.</p>
                                    </div>
                                )}

                                {!apptForm.type.includes('Pack') && (
                                    <div>
                                        <label className="block text-xs font-bold uppercase text-gray-400 mb-1">Monto Pagado</label>
                                        <input type="number" className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none"
                                            value={apptForm.paidAmount} onChange={e => setApptForm({...apptForm, paidAmount: parseInt(e.target.value)})} />
                                    </div>
                                )}

                                <div>
                                    <label className="block text-xs font-bold uppercase text-gray-400 mb-1">Fecha Cita</label>
                                    <input required type="date" className="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none"
                                        value={apptForm.date} onChange={e => setApptForm({...apptForm, date: e.target.value})} />
                                    {!editingItem && <p className="text-[10px] text-gray-400 mt-1 italic">* Sugerencia: Agendar cada 15 días.</p>}
                                </div>

                                <button type="submit" className="w-full bg-[#7A2E2A] text-white py-3 rounded-xl font-bold hover:bg-opacity-90 transition-all mt-4 shadow-lg">{editingItem ? 'Actualizar Cita' : 'Confirmar'}</button>
                            </form>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
}
